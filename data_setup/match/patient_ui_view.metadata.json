{"options":{"viewOn":"patient","pipeline":[{"$project":{"patientSequenceNumber":1.0,"currentPatientStatus":1.0,"currentStepNumber":1.0,"diseases":1.0,"patientAssignments":1.0,"patientTriggers":1.0,"lastTrigger":{"$arrayElemAt":["$patientTriggers",-1.0]},"lastAssignment":{"$arrayElemAt":["$patientAssignments",-1.0]},"isOutsideAssay":{"$let":{"vars":{"oaTriggers":{"$filter":{"input":"$patientTriggers","cond":{"$eq":["$$this.patientStatus","REGISTRATION_OUTSIDE_ASSAY"]}}}},"in":{"$cond":{"if":{"$eq":["$$oaTriggers",[]]},"then":false,"else":true}}}},"registrationDate":1.0,"registrationDateFormatted":{"$let":{"vars":{"monthnum":{"$month":"$registrationDate"},"dayNum":{"$dayOfMonth":"$registrationDate"},"year":{"$dateToString":{"format":"%Y","date":"$registrationDate"}},"hour":{"$switch":{"branches":[{"case":{"$gt":[{"$hour":"$registrationDate"},12.0]},"then":{"$subtract":[{"$hour":"$registrationDate"},12.0]}},{"case":{"$eq":[{"$hour":"$registrationDate"},0.0]},"then":{"$add":[{"$hour":"$registrationDate"},12.0]}}],"default":{"$hour":"$registrationDate"}}},"minute":{"$dateToString":{"format":"%M","date":"$registrationDate"}},"amOrPm":{"$cond":{"if":{"$lt":[{"$hour":"$registrationDate"},12.0]},"then":"AM","else":"PM"}}},"in":{"$concat":[{"$switch":{"branches":[{"case":{"$eq":["$$monthnum",1.0]},"then":"January"},{"case":{"$eq":["$$monthnum",2.0]},"then":"February"},{"case":{"$eq":["$$monthnum",3.0]},"then":"March"},{"case":{"$eq":["$$monthnum",4.0]},"then":"April"},{"case":{"$eq":["$$monthnum",5.0]},"then":"May"},{"case":{"$eq":["$$monthnum",6.0]},"then":"June"},{"case":{"$eq":["$$monthnum",7.0]},"then":"July"},{"case":{"$eq":["$$monthnum",8.0]},"then":"August"},{"case":{"$eq":["$$monthnum",9.0]},"then":"September"},{"case":{"$eq":["$$monthnum",10.0]},"then":"October"},{"case":{"$eq":["$$monthnum",11.0]},"then":"November"},{"case":{"$eq":["$$monthnum",12.0]},"then":"December"}]}}," ",{"$cond":{"if":{"$lt":["$$dayNum",10.0]},"then":{"$substr":["$$dayNum",0.0,1.0]},"else":{"$substr":["$$dayNum",0.0,2.0]}}},", ","$$year"," ",{"$cond":{"if":{"$lt":["$$hour",10.0]},"then":{"$substr":["$$hour",0.0,1.0]},"else":{"$substr":["$$hour",0.0,2.0]}}},":","$$minute"," ","$$amOrPm"]}}}}},{"$addFields":{"offTrialDate":{"$cond":{"if":{"$eq":[{"$indexOfCP":["$currentPatientStatus","OFF_TRIAL"]},0.0]},"then":"$lastTrigger.dateCreated","else":null}}}},{"$addFields":{"treatmentArm":{"$cond":{"if":{"$in":["$currentPatientStatus",["ON_TREATMENT_ARM","PENDING_CONFIRMATION","PENDING_APPROVAL"]]},"then":"$lastAssignment.treatmentArm","else":null}}}}]},"indexes":[]}