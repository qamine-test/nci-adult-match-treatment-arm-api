{"options":{"viewOn":"patient","pipeline":[{"$project":{"biopsies":1.0,"patientSequenceNumber":1.0}},{"$unwind":"$biopsies"},{"$project":{"biopsySequenceNumber":"$biopsies.biopsySequenceNumber","patientSequenceNumber":1.0,"biopsies.mdAndersonMessages.biopsySequenceNumber":1.0,"biopsies.mdAndersonMessages.patientSequenceNumber":1.0,"biopsies.mdAndersonMessages.molecularSequenceNumber":1.0,"biopsies.mdAndersonMessages.destinationSite":1.0,"biopsies.mdAndersonMessages.trackingNumber":1.0,"biopsies.mdAndersonMessages.reportedDate":1.0,"biopsies.mdAndersonMessages.message":1.0,"_id":0.0}},{"$project":{"biopsySequenceNumber":1.0,"patientSequenceNumber":1.0,"hasMsn":{"$filter":{"input":"$biopsies.mdAndersonMessages","as":"msg","cond":{"$ifNull":["$$msg.molecularSequenceNumber",false]}}},"specimenReceived":{"$reverseArray":{"$filter":{"input":"$biopsies.mdAndersonMessages","as":"msg","cond":{"$eq":["$$msg.message","SPECIMEN_RECEIVED"]}}}},"specimenFailure":{"$reverseArray":{"$filter":{"input":"$biopsies.mdAndersonMessages","as":"msg","cond":{"$eq":["$$msg.message","SPECIMEN_FAILURE"]}}}},"pathologyConfirmation":{"$reverseArray":{"$filter":{"input":"$biopsies.mdAndersonMessages","as":"msg","cond":{"$eq":["$$msg.message","PATHOLOGY_CONFIRMATION"]}}}}}},{"$unwind":{"path":"$hasMsn","preserveNullAndEmptyArrays":true}},{"$project":{"biopsySequenceNumber":1.0,"patientSequenceNumber":1.0,"molecularSequenceNumber":"$hasMsn.molecularSequenceNumber","location":"$hasMsn.destinationSite","trackingNumber":"$hasMsn.trackingNumber","nucleicAcidSendoutDate":"$hasMsn.reportedDate","specimenReceivedDate":{"$arrayElemAt":["$specimenReceived.reportedDate",0.0]},"specimenFailureDate":{"$arrayElemAt":["$specimenFailure.reportedDate",0.0]},"pathologyConfirmationDate":{"$arrayElemAt":["$pathologyConfirmation.reportedDate",0.0]}}}]},"indexes":[]}